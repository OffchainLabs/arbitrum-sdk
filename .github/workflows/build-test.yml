name: Build, Test & Security Audit

on:
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  MAINNET_RPC: ${{ secrets.MAINNET_RPC }}
  NODE_OPTIONS: "--max-old-space-size=4096" # Bellek hatalarını önlemek için

jobs:
  # 1. HAZIRLIK: Bağımlılıkları bir kez kurup önbelleğe alıyoruz
  setup:
    name: Setup & Cache Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    outputs:
      cache-key: ${{ steps.set-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - id: set-key
        run: echo "key=${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        uses: OffchainLabs/actions/node-modules/install@main
        with:
          cache-key: ${{ steps.set-key.outputs.key }}

  # 2. KALİTE VE GÜVENLİK (Paralel Çalışır)
  quality_checks:
    name: Lint & Audit
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Restore node_modules
        uses: OffchainLabs/actions/node-modules/install@main
        with:
          cache-key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Run Quality Gate
        run: |
          yarn gen:abi
          yarn build
          yarn lint --format junit -o /tmp/sdk-lint.xml
          yarn audit:ci

      - name: Publish Reports
        uses: mikepenz/action-junit-report@v5
        if: always()
        with:
          report_paths: '/tmp/*.xml'
          fail_on_failure: true

  # 3. TESTLER (Unit ve Integration Paralel)
  tests:
    name: Tests (Unit & Integration)
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [20] # Sadece en güncel LTS'de koşarak kaynak tasarrufu
        orbit-test: ['0', '1']
        decimals: ['18', '16', '20']
        exclude:
          - orbit-test: '0'
            decimals: '16'
          - orbit-test: '0'
            decimals: '20'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Restore node_modules
        uses: OffchainLabs/actions/node-modules/install@main
        with:
          cache-key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Run Nitro Test Node
        uses: OffchainLabs/actions/run-nitro-test-node@main
        with:
          nitro-testnode-ref: release
          l3-node: ${{ matrix.orbit-test == '1' }}
          args: ${{ matrix.decimals != '18' && format('--l3-fee-token --l3-fee-token-decimals {0}', matrix.decimals) || (matrix.orbit-test == '1' && '--l3-fee-token' || '') }}

      - name: Execute Tests
        run: |
          cp .env-sample .env
          yarn gen:abi && yarn build && yarn gen:network
          CI=true yarn test:unit
          CI=true yarn test:integration
        env:
          ORBIT_TEST: ${{ matrix.orbit-test }}
          DECIMALS: ${{ matrix.decimals }}
